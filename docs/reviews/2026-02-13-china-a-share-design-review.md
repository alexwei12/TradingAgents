# Design Review: China A-Share Support for TradingAgents

**è¢«è¯„å®¡æ–‡æ¡£**: `docs/plans/2026-02-13-china-a-share-design.md`  
**è¯„å®¡æ—¥æœŸ**: 2026-02-13  
**è¯„å®¡æ–¹å¼**: ä»£ç æ¯”å¯¹ + æ¶æ„åˆ†æ

---

## æ€»ä½“è¯„ä»·

è¿™æ˜¯ä¸€ä»½é«˜è´¨é‡ã€ç»“æ„æ¸…æ™°çš„è®¾è®¡æ–‡æ¡£ã€‚æ–¹æ¡ˆæ•´ä½“æ€è·¯æ­£ç¡®â€”â€”åˆ©ç”¨ç°æœ‰çš„ vendor routing æ¡†æ¶ï¼Œé€šè¿‡æ–°å¢ AKShare vendor æ¥æ”¯æŒ A è‚¡æ•°æ®ï¼Œé¿å…å¯¹ agent å±‚å’Œ LangGraph workflow åšä»»ä½•ä¿®æ”¹ã€‚è¿™ä¸ªæ–¹å‘æ˜¯å¯¹çš„ã€‚

ä½†åœ¨ä»”ç»†æ¯”å¯¹äº†ç°æœ‰ä»£ç ä¹‹åï¼Œå‘ç°äº†è‹¥å¹²å®é™…å¯è¡Œæ€§é—®é¢˜ï¼Œä»å…³é”®åˆ°æ¬¡è¦ä¾æ¬¡åˆ—å‡ºã€‚

---

## ğŸ”´ Critical Issuesï¼ˆå¿…é¡»ä¿®å¤ï¼‰

### 1. `route_to_vendor` ç­¾åä¸æ¥å— `ticker` å‚æ•° â€” æ ¸å¿ƒè·¯ç”±é€»è¾‘è¡Œä¸é€š

**æ–‡æ¡£æè¿°**:
```python
def route_to_vendor(tool_name, category, config, ticker=None):
    if ticker and is_china_stock(ticker):
        vendor = "akshare"
```

**å®é™…ä»£ç **ï¼ˆ`interface.py` ç¬¬ 134 è¡Œï¼‰:
```python
def route_to_vendor(method: str, *args, **kwargs):
```

ç°æœ‰çš„ `route_to_vendor` æ¥æ”¶çš„æ˜¯ `(method, *args, **kwargs)`ï¼Œticker è¢«åŒ…å«åœ¨ `*args` é‡Œé¢ï¼ˆä½ç½®ä¸åŒå·¥å…·ä¹Ÿä¸ä¸€æ ·ï¼‰ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæ˜¾å¼çš„å‚æ•°ã€‚æ–‡æ¡£ä¸­çš„ä¼ªä»£ç æŠŠç­¾åå®Œå…¨ç®€åŒ–äº†ï¼Œå¿½ç•¥äº†ä»¥ä¸‹é—®é¢˜ï¼š

- **ticker åœ¨ä¸åŒå·¥å…·é‡Œçš„ä½ç½®ä¸åŒ**ï¼š`get_stock_data(symbol, start, end)` vs `get_global_news(curr_date, look_back_days, limit)` â€” åè€…æ ¹æœ¬æ²¡æœ‰ ticker å‚æ•°
- **`get_global_news` æ²¡æœ‰ ticker å‚æ•°**ï¼šæ–‡æ¡£è¯´"A-share tickers get Chinese macro news"ï¼Œä½† `get_global_news` è°ƒç”¨æ—¶ä¸ä¼  tickerï¼ˆå‚è§ `news_data_tools.py` ç¬¬ 39 è¡Œï¼‰ï¼Œ`route_to_vendor` æ— ä»å¾—çŸ¥å½“å‰åœ¨åˆ†æå“ªæ”¯è‚¡ç¥¨

**å»ºè®®**:
- æ–¹æ¡ˆéœ€è¦æ˜ç¡® **å¦‚ä½•å°† ticker ä¼ å…¥è·¯ç”±å±‚**ã€‚æœ‰å‡ ç§é€‰æ‹©ï¼š
  - **(A)** åœ¨ `route_to_vendor` çš„ `*args` ä¸­è§£æç¬¬ä¸€ä¸ªå‚æ•°ä½œä¸º tickerï¼ˆä½†å¯¹ `get_global_news` æ— æ•ˆï¼‰
  - **(B)** å¼•å…¥ context/thread-local å˜é‡ï¼Œåœ¨ graph æ‰§è¡Œå¼€å§‹æ—¶è®¾ç½®å½“å‰ tickerï¼ˆæ¨èï¼‰
  - **(C)** ä¿®æ”¹æ‰€æœ‰ tool å‡½æ•°çš„ç­¾ååŠ ä¸Š ticker å‚æ•°ï¼ˆä¾µå…¥æ€§å¤§ï¼‰
- **`get_global_news` çš„è·¯ç”±æ˜¯æœ€éš¾å¤„ç†çš„ç‚¹**ï¼Œå¿…é¡»åœ¨æ–‡æ¡£ä¸­æ˜ç¡®æ–¹æ¡ˆ

### 2. å‡½æ•°ç­¾åä¸åŒ¹é… â€” AKShare å‡½æ•°çš„å‚æ•°ç­¾åå¿…é¡»ä¸ç°æœ‰ vendor å¯¹é½

ç°æœ‰å„ vendor å®ç°çš„ç­¾åå¦‚ä¸‹ï¼ˆä» `VENDOR_METHODS` å’Œå®é™…ä»£ç ä¸­å¾—å‡ºï¼‰ï¼š

| Tool | yfinance ç­¾å | æ–‡æ¡£ä¸­ AKShare ç­¾å |
|------|-------------|-----------------|
| `get_stock_data` | `(symbol, start_date, end_date)` | `(ticker, start, end)` â€” âœ… åŒ¹é… |
| `get_indicators` | `(symbol, indicator, curr_date, look_back_days)` | æ–‡æ¡£ä¸­è¯´"OHLCV + stockstats"ä½†æ²¡ç»™ç­¾å â€” âš ï¸ éœ€è¦æ˜ç¡® |
| `get_fundamentals` | `(ticker, curr_date)` | `(ticker)` â€” âŒ å°‘ä¸€ä¸ªå‚æ•° |
| `get_balance_sheet` | `(ticker, freq, curr_date)` | `(ticker)` â€” âŒ å°‘ä¸¤ä¸ªå‚æ•° |
| `get_cashflow` | `(ticker, freq, curr_date)` | `(ticker)` â€” âŒ å°‘ä¸¤ä¸ªå‚æ•° |
| `get_income_statement` | `(ticker, freq, curr_date)` | `(ticker)` â€” âŒ å°‘ä¸¤ä¸ªå‚æ•° |
| `get_news` | `(ticker, start_date, end_date)` | `(ticker)` â€” âŒ å°‘ä¸¤ä¸ªå‚æ•° |
| `get_insider_transactions` | `(ticker)` | `(ticker)` â€” âœ… åŒ¹é… |

**é—®é¢˜**ï¼š`route_to_vendor` æ˜¯é€šè¿‡ `impl_func(*args, **kwargs)` é€ä¼ å‚æ•°çš„ã€‚å¦‚æœ AKShare å®ç°çš„å‡½æ•°ç­¾åä¸ä¸€è‡´ï¼Œè°ƒç”¨æ—¶ä¼šæŠ› TypeErrorã€‚

**å»ºè®®**ï¼šæ–‡æ¡£çš„å‡½æ•°ç­¾åè¡¨éœ€è¦è¡¥å……å®Œæ•´ç­¾åï¼ˆåŒ…æ‹¬ `*args` ä¸­ä¼šæ”¶åˆ°çš„æ‰€æœ‰å‚æ•°ï¼‰ï¼Œå³ä½¿æŸäº›å‚æ•°åœ¨ AKShare å®ç°ä¸­ä¸ç”¨ï¼Œä¹Ÿè¦åœ¨ç­¾åä¸­å£°æ˜å¹¶å¿½ç•¥ï¼ˆæˆ–ä½¿ç”¨ `**kwargs`ï¼‰ã€‚

### 3. `StockstatsUtils` ç¡¬ç¼–ç äº† `yfinance` â€” æŠ€æœ¯æŒ‡æ ‡è·¯ç”±ä¸é€š

`stockstats_utils.py` ä¸­ `get_stock_stats` ç›´æ¥è°ƒç”¨ `yf.download()` è·å–åŸå§‹æ•°æ®ï¼š

```python
data = yf.download(symbol, start=start_date_str, end=end_date_str, ...)
```

æ–‡æ¡£è¯´"OHLCV + `stockstats` calculation â€” Same approach as yfinance"ï¼Œä½†å®é™…å®ç°ä¸­ **stockstats çš„æ•°æ®æºå°±æ˜¯ yfinance**ã€‚å¦‚æœ A è‚¡èµ° AKShare è·¯å¾„ï¼Œè¿™é‡Œçš„ `yf.download("600519.SH")` ä¼šå¤±è´¥æˆ–è¿”å›é”™è¯¯æ•°æ®ã€‚

**å»ºè®®**ï¼š
- AKShare çš„ `get_indicators` å®ç°éœ€è¦ **å®Œå…¨ç‹¬ç«‹å®ç°**ï¼Œä¸èƒ½å¤ç”¨ `StockstatsUtils`
- åº”è¯¥å…ˆé€šè¿‡ `ak.stock_zh_a_hist()` è·å– OHLCVï¼Œç„¶åç”¨ `stockstats.wrap()` è®¡ç®—æŒ‡æ ‡
- åœ¨æ–‡æ¡£ä¸­æ˜ç¡®è¿™ä¸€ç‚¹

---

## ğŸŸ¡ Important Issuesï¼ˆå¼ºçƒˆå»ºè®®ä¿®å¤ï¼‰

### 4. `VENDOR_METHODS` æ³¨å†Œç¼ºå¤±

æ–‡æ¡£åªæè¿°äº† `route_to_vendor` ä¸­çš„ `if vendor == "akshare"` åˆ†æ”¯é€»è¾‘ï¼Œä½†æ²¡æœ‰æåˆ°éœ€è¦åœ¨ `VENDOR_METHODS` å­—å…¸ä¸­æ³¨å†Œ AKShare çš„å®ç°ã€‚å½“å‰è·¯ç”±æ¡†æ¶çš„æ ¸å¿ƒæ˜¯ `VENDOR_METHODS`ï¼ˆç¬¬ 69-110 è¡Œï¼‰ï¼Œ`route_to_vendor` ä»è¿™ä¸ªå­—å…¸ä¸­æŸ¥æ‰¾å®ç°ã€æ„å»º fallback chainã€‚

**å»ºè®®**ï¼šæ–‡æ¡£åº”æ˜ç¡® `VENDOR_METHODS` çš„ä¿®æ”¹ï¼š
```python
VENDOR_METHODS = {
    "get_stock_data": {
        "alpha_vantage": ...,
        "yfinance": ...,
        "akshare": get_akshare_stock_data,  # æ–°å¢
    },
    # ... åŒç†å…¶ä»–å·¥å…·
}
```

å¹¶ä¸” `VENDOR_LIST` ä¹Ÿéœ€è¦åŠ å…¥ `"akshare"`ã€‚

### 5. Fallback è¡Œä¸ºä¸æ˜ç¡®

ç°æœ‰çš„ fallback æœºåˆ¶åªåœ¨ `AlphaVantageRateLimitError` æ—¶è§¦å‘ï¼ˆç¬¬ 159 è¡Œï¼‰ã€‚å¦‚æœ AKShare è°ƒç”¨å¤±è´¥ï¼ˆç½‘ç»œè¶…æ—¶ã€æ•°æ®è§£æé”™è¯¯ç­‰ï¼‰ï¼Œå½“å‰æ¡†æ¶ **ä¸ä¼š fallback** åˆ°å…¶ä»– vendorï¼Œå› ä¸ºé `AlphaVantageRateLimitError` çš„å¼‚å¸¸ä¼šç›´æ¥æŠ›å‡ºã€‚

å¯¹äº A è‚¡æ¥è¯´ï¼Œå³ä½¿ AKShare å¤±è´¥ä¹Ÿæ— æ³• fallback åˆ° yfinanceï¼ˆyfinance ä¸æ”¯æŒ A è‚¡ï¼‰ï¼Œä½†è¿™ä¸ªè¡Œä¸ºåº”è¯¥åœ¨æ–‡æ¡£ä¸­è¯´æ˜ã€‚åŒæ—¶å»ºè®®ï¼š
- æ‰©å±• fallback æœºåˆ¶ï¼Œå¢åŠ é€šç”¨çš„ `VendorUnavailableError`ï¼Œè€Œéåªæ•è· `AlphaVantageRateLimitError`

### 6. ç¼“å­˜å±‚æœªæåŠ

ç°æœ‰çš„ `stockstats_utils.py` æœ‰æ–‡ä»¶çº§åˆ«çš„ç¼“å­˜ï¼ˆ`.csv` æ–‡ä»¶ï¼‰ï¼ŒAKShare çš„æ•°æ®æ˜¯å¦ä¹Ÿéœ€è¦ç¼“å­˜ï¼Ÿè€ƒè™‘åˆ°ï¼š
- AKShare ä¾èµ–ç½‘ç»œçˆ¬å– Eastmoney/Sinaï¼Œé€Ÿåº¦è¾ƒæ…¢
- åŒä¸€æ¬¡åˆ†æä¸­å¤šä¸ª analyst å¯èƒ½æŸ¥è¯¢åŒä¸€åªè‚¡ç¥¨çš„æ•°æ®

**å»ºè®®**ï¼šæ–‡æ¡£åº”æåŠ AKShare æ•°æ®çš„ç¼“å­˜ç­–ç•¥ã€‚é¡¹ç›®å·²æœ‰ DuckDB ç¼“å­˜è®¡åˆ’ï¼Œè¿™é‡Œåº”è¯´æ˜æ˜¯å¦å¤ç”¨ã€‚

### 7. æ—¥æœŸæ ¼å¼å·®å¼‚

AKShare çš„ `stock_zh_a_hist()` ä½¿ç”¨ `YYYYMMDD` æ ¼å¼ï¼ˆå¦‚ `"20260115"`ï¼‰ï¼Œè€Œç³»ç»Ÿçš„ç»Ÿä¸€æ—¥æœŸæ ¼å¼æ˜¯ `"YYYY-mm-dd"`ï¼ˆå¦‚ `"2026-01-15"`ï¼‰ã€‚æ–‡æ¡£æœªæåŠæ ¼å¼è½¬æ¢é€»è¾‘ã€‚

**å»ºè®®**ï¼šåœ¨ `akshare_data.py` çš„è®¾è®¡ä¸­æ˜ç¡®æ—¥æœŸæ ¼å¼è½¬æ¢ã€‚

---

## ğŸŸ¢ Minor Issuesï¼ˆå»ºè®®æ”¹è¿›ï¼‰

### 8. ç¤¾äº¤èˆ†æƒ…çš„æ•°æ®è´¨é‡

æ–‡æ¡£è¯´ç¤¾äº¤èˆ†æƒ… "Append to `get_news` return"ã€‚`ak.stock_hot_rank_em()` è¿”å›çš„æ˜¯çƒ­åº¦æ’åå’Œå…³æ³¨åº¦å˜åŒ–è¶‹åŠ¿ï¼Œå¹¶éçœŸæ­£çš„ç¤¾äº¤åª’ä½“èˆ†æƒ…åˆ†æã€‚åº”è¯¥åœ¨æ–‡æ¡£ä¸­æ›´ç²¾ç¡®åœ°æè¿°è¿”å›å†…å®¹ã€‚

### 9. DataFlow å›¾ä¸å®é™…ä»£ç çš„å·®å¼‚

æ–‡æ¡£çš„æ•°æ®æµå›¾è¯´ `interface.route_to_vendor() â†’ forces "akshare" for CN tickers`ï¼Œä½†å®é™…ä¸Š tool å±‚ï¼ˆå¦‚ `get_stock_data` toolï¼‰ç›´æ¥è°ƒç”¨ `route_to_vendor("get_stock_data", symbol, start_date, end_date)`ï¼Œä¸­é—´æ²¡æœ‰æ˜¾å¼çš„ `interface.route_to_vendor()` è°ƒç”¨ â€” å·¥å…·å±‚ç›´æ¥è°ƒçš„å°±æ˜¯ `route_to_vendor`ã€‚å›¾å¯ä»¥æ›´ç²¾ç¡®åœ°åæ˜ è°ƒç”¨é“¾ã€‚

### 10. æµ‹è¯•ç­–ç•¥ç¼ºå¤±

æ–‡æ¡£æ²¡æœ‰æåŠæµ‹è¯•è®¡åˆ’ã€‚å»ºè®®è‡³å°‘åŒ…æ‹¬ï¼š
- å•å…ƒæµ‹è¯•ï¼š`ticker_utils.py` çš„å¸‚åœºæ£€æµ‹
- é›†æˆæµ‹è¯•ï¼šç«¯åˆ°ç«¯ A è‚¡æ•°æ®è·å–
- Mock æµ‹è¯•ï¼šAKShare API ä¸å¯ç”¨æ—¶çš„è¡Œä¸º

---

## âœ… æ–‡æ¡£åšå¾—å¥½çš„åœ°æ–¹

- **Key Decisions è¡¨æ ¼æ¸…æ™°**ï¼Œæ¯ä¸ªå†³ç­–éƒ½æœ‰ rationale
- **Out of Scope æ˜ç¡®**ï¼Œé¿å…èŒƒå›´è”“å»¶
- **Prerequisites & Risks è¡¨æ ¼** å……åˆ†è€ƒè™‘äº†å®é™…é£é™©ï¼ˆå‡æ—¥æ—¥å†ã€ç½‘ç»œé™åˆ¶ç­‰ï¼‰
- **"Feed Chinese text directly to LLM"** æ˜¯æ­£ç¡®å†³ç­–ï¼Œé¿å…äº†ä¸å¿…è¦çš„ç¿»è¯‘å±‚
- **å……åˆ†åˆ©ç”¨ç°æœ‰æ¡†æ¶**ï¼Œä¸ä¿®æ”¹ agent/graph å±‚çš„è®¾è®¡æ–¹å‘æ­£ç¡®

---

## ğŸ“Š å¯è¡Œæ€§è¯„ä¼°æ€»ç»“

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| **æŠ€æœ¯æ–¹å‘** | â­â­â­â­â­ | æ–¹å‘å®Œå…¨æ­£ç¡®ï¼Œåˆ©ç”¨ vendor æ‰©å±•æ˜¯æœ€å°ä¾µå…¥æ–¹æ¡ˆ |
| **æ¶æ„ä¸€è‡´æ€§** | â­â­â­â­ | éµå¾ªç°æœ‰æ¨¡å¼ï¼Œä½†è·¯ç”±ç»†èŠ‚éœ€è¦ä¸å®é™…ä»£ç å¯¹é½ |
| **å®ç°ç»†èŠ‚** | â­â­â˜†â˜†â˜† | å‡½æ•°ç­¾åã€è·¯ç”±æœºåˆ¶ã€ticker ä¼ é€’ç­‰æ ¸å¿ƒç»†èŠ‚æœ‰é‡å¤§é—æ¼ |
| **é£é™©ç®¡ç†** | â­â­â­â­ | é£é™©è¯†åˆ«åˆ°ä½ï¼Œä½†ç¼“å­˜å’Œ fallback éœ€è¡¥å…… |
| **å¯å®æ–½æ€§** | â­â­â­â˜†â˜† | è§£å†³ä¸Šè¿° 3 ä¸ª Critical Issue åå¯å®æ–½ |

**ç»“è®º**ï¼šæ–¹æ¡ˆ **æ–¹å‘å¯è¡Œ**ï¼Œä½†å¿…é¡»ä¿®è®¢ä»¥ä¸‹å†…å®¹æ‰èƒ½è¿›å…¥å®æ–½é˜¶æ®µï¼š

1. âœï¸ æ˜ç¡® ticker å¦‚ä½•ä¼ å…¥è·¯ç”±å±‚ï¼ˆå°¤å…¶æ˜¯ `get_global_news` çš„å¤„ç†ï¼‰
2. âœï¸ å¯¹é½æ‰€æœ‰ AKShare å‡½æ•°ç­¾åä¸ç°æœ‰ vendor ç­¾å
3. âœï¸ è¯´æ˜ `get_indicators` å¦‚ä½•ç‹¬ç«‹è·å– OHLCV æ•°æ®ï¼ˆä¸ä¾èµ– yfinanceï¼‰
4. âœï¸ è¡¥å…… `VENDOR_METHODS` å’Œ `VENDOR_LIST` çš„ä¿®æ”¹è¯´æ˜
5. âœï¸ è¡¥å……æ—¥æœŸæ ¼å¼è½¬æ¢å’Œç¼“å­˜ç­–ç•¥çš„è¯´æ˜
